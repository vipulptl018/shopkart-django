{% extends 'base.html' %}
{% load static %}


{% block content %}

<section class="section-content padding-y bg">
<div class="container">
 
<!-- ============================ COMPONENT 1 ================================= -->
<h4 class='text-center m-2' >Review Your Order And Make Payment</h4>
<div class="row">
	<aside class="col-lg-8">
<div class="card">
  <div class="card-header">
      <h5 class="card-title">Billing Address</h5>
  </div>
  <div class="card-body">
    <p class="card-text">{{order.full_name}}</p>
    <p class="card-text">{{order.full_address}}</p>
    <p class="card-text">{{order.city}} {{order.state}}</p>
    <p class="card-text">{{order.county}}</p>
    <p class="card-text">{{order.email}}</p>
    <p class="card-text">{{order.phone}}</p>
    {% if order.order_note %}
    <br> Order Note : <br>{{order.order_note}}
    {% else %}

    {% endif %}
  </div>
</div>
<div class="card">
  <div class="card-header">
      <h5 class="card-title">PayPal</h5>
  </div>
  <div class="card-body">
    <p class="card-text">PayPal.</p>
  </div>
</div>
<div class="card">
  <div class="card-header">
      <h5 class="card-title">Review Products</h5>
  </div>
  <div class="card-body">
    <table class="table table-borderless table-shopping-cart">
<thead class="text-muted">
<tr class="small text-uppercase">
  <th scope="col">Product</th>
  <th scope="col" width="120">Quantity</th>
  <th scope="col" width="120">Price</th>
</tr>
</thead>
<tbody>
    

{% for cart_item in cart_items %}
<tr>
	<td>
		<figure class="itemside align-items-center">
			<div class="aside"><img src="{{ cart_item.product.p_image.url }}" class="img-sm"></div>
			<figcaption class="info">
				<a href="{{ cart_item.product.get_url }}" class="title text-dark">{{ cart_item.product.product_name }}</a>
				<p class="text-muted small"> 
					{% if cart_item.variations.all %}
					{% for item in cart_item.variations.all %}
						 {{ item.variation_category | lower }} : {{ item.variation_value | capfirst }}<br> 
					{% endfor %}
					{% endif %}
				</p>
			</figcaption>
		</figure>
	</td>
	<td> 
		<!-- col.// -->
					<div>{{cart_item.quantity}}</div>
	</td>
	<td> 
		<div class="price-wrap"> 
			<var class="price">${{ cart_item.sub_total }}</var> 
			<small class="text-muted"> ${{ cart_item.product.price }} each </small> 
		</div> <!-- price-wrap .// -->
	</td>

</tr>
{% endfor %}

</tbody>
</table>  </div>
</div>

	</aside> <!-- col.// -->
	<aside class="col-lg-4">

		<div class="card">
		<div class="card-body">
			<dl class="dlist-align">
			  <dt>Total price:</dt>
			  <dd class="text-right">{{total}}</dd>
			</dl>
			<dl class="dlist-align">
			  <dt>Tax:</dt>
			  <dd class="text-right"> ${{ tax }}</dd>
			</dl>
			<dl class="dlist-align">
			  <dt>Grand Total:</dt>
			  <dd class="text-right text-dark b"><strong>${{ grand_total}}</strong></dd>
			</dl>
			<hr>
			<p class="text-center mb-3">
				<img src="{% static './images/misc/payments.png' %}" height="26">
			</p>
			{% comment %} <a href="{% url 'checkout' %}" class="btn btn-primary btn-block"> Checkout </a>
			<a href="{% url 'store' %}" class="btn btn-light btn-block">Continue Shopping</a> {% endcomment %}

                <div id="paypal-button-container"></div>

		</div> <!-- card-body.// -->
		</div> <!-- card.// -->

</aside> <!-- col.// -->


</div> <!-- row.// -->

<!-- ============================ COMPONENT 1 END .// ================================= -->

</div> <!-- container .//  -->
</section>
<!-- ========================= SECTION CONTENT END// ========================= -->

            {% comment %} This is paypal integration code {% endcomment %}
<!-- Include PayPal SDK script -->

<script>
  // Utility: get a cookie value by name
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }

  var amount = "{{grand_total}}";
  var url = "{% url 'payment' %}";
  var csrftoken = getCookie('csrftoken');
  var payment_method = "PayPal";
  var orderID = "{{ order.order_number }}";
  var redirect_url = "{% url 'order_complete' %}"

  paypal.Buttons({
    style: {
      color: 'blue',
      shape: 'pill',
      label: 'pay',
      height: 40
    },

    // Create the order on client side
    createOrder: function(data, actions) {
      return actions.order.create({
        purchase_units: [{
          amount: {
            value: amount // Dynamic amount from Django template
          }
        }]
      });
    },

    // Capture payment on approval
    onApprove: function(data, actions) {
      return actions.order.capture().then(function(orderData) {
        console.log('Order successful: ', orderData);

        var transaction = orderData.purchase_units[0].payments.captures[0];

        // Send data to Django backend
        fetch(url, {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "X-CSRFToken": csrftoken,
          },
          body: JSON.stringify({
            orderID: orderID,
            transID: transaction.id,
            payment_method: payment_method,
            status: transaction.status,
          }),
        })
        {% comment %} order completed code start {% endcomment %}
        .then(response => response.json())
        .then(data => {
          console.log("Payment saved:", data);
          alert('Transaction ' + transaction.status + ' : ' + transaction.id);
          // Optionally redirect
          window.location.href = redirect_url + '?order_number='+data.order_number+'&payment_id='+data.transID;
        })
        .catch(error => console.error("Error saving payment:", error));
        {% comment %} order completed code end {% endcomment %}
      });
    },

    // Handle errors
    onError: function(err) {
      console.error('PayPal Checkout error', err);
      alert('Something went wrong with the payment.');
    }

  }).render('#paypal-button-container');
</script>

{% endblock %}
